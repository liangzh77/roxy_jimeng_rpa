# 即梦(jimeng.jianying.com) 视频生成自动化方案

## 一、完整操作流程

以下为在即梦平台上完成一次"视频生成"任务的完整步骤：

| 步骤 | 操作 | 说明 |
|------|------|------|
| 1 | 打开 jimeng.jianying.com | 需要已登录状态 |
| 2 | 点击"生成"按钮 | 页面顶部导航 |
| 3 | 在下拉菜单中选择"视频生成" | 下拉选项，非直接链接 |
| 4 | 确认模型为 Seedance 2.0 | 注意不要选 Lite 版本 |
| 5 | 选择"全能参考"模式 | 从参考模式下拉框选择 |
| 6 | 修正模型版本 | 选择"全能参考"后模型会自动切换为 Fast，需手动改回"全能王者" |
| 7 | 设置画幅比例 9:16 | 点击比例选择器 |
| 8 | 设置时长 8s | 点击时长选择器 |
| 9 | 上传参考图片 1 | 通过"参考内容"区域的文件上传 |
| 10 | 上传参考图片 2 | 同上 |
| 11 | 输入提示词（含 @ 引用） | 在富文本编辑器中输入文字，穿插 @图片1、@图片2 引用 |
| 12 | 点击"生成" | 提交任务 |

## 二、实际遇到的技术难点

### 2.1 隐藏元素与零尺寸元素
- 页面中存在多个同名文本节点（如"视频生成"），部分为隐藏的占位元素
- 需要通过 `getBoundingClientRect()` 判断哪个元素实际可见
- 下拉菜单的 `<li>` 选项在未展开时尺寸为 0

### 2.2 模型自动切换
- 选择"全能参考"模式后，模型会自动从 Seedance 2.0 切换为 Seedance 2.0 Fast
- 必须在选完模式后，重新打开模型下拉框，选回正确版本

### 2.3 隐藏的文件上传输入框
- 上传图片的 `<input type="file">` 是 `display:none` 的隐藏元素
- 页面中有多个 file input，需要从"参考内容"文本节点向上遍历 DOM 树找到正确的那个
- 实际操作中找到的是第 3 个（index=2）file input

### 2.4 富文本编辑器与 @ 提及系统
- 提示词输入框是富文本编辑器，不是普通 `<input>`
- 输入 `@` 字符会触发一个下拉选择列表（listbox）
- 需要先输入 `@`，等待列表弹出，点击对应选项，再继续输入普通文本
- 普通文本使用 `document.execCommand('insertText', false, '文本')` 插入

### 2.5 DOM 动态变化
- 每次交互（上传图片、展开下拉）后，页面 DOM 会发生变化
- 之前获取的元素 UID 会失效，需要重新获取快照

## 三、自动化工具对比分析

| 维度 | Chrome 插件 | Selenium | Puppeteer | Playwright |
|------|------------|----------|-----------|------------|
| **浏览器支持** | 仅 Chrome | 多浏览器 | 仅 Chromium | Chromium/Firefox/WebKit |
| **运行环境** | 浏览器内 | 需 WebDriver | Node.js | Node.js/Python/Java/C# |
| **登录态复用** | 天然复用 | 需处理 | 可连接已有浏览器 | 支持 connectOverCDP |
| **RoxyBrowser 集成** | 不支持 | 需 chromedriver 对接 | 可通过 CDP | **原生 connectOverCDP** |
| **隐藏元素处理** | 直接操作 DOM | 受限 | CDP 协议直接操作 | 内置 force click |
| **文件上传** | 需 background 权限 | sendKeys | setInputFiles | **setInputFiles** |
| **富文本/execCommand** | 直接执行 | 需 executeScript | evaluate | **evaluate** |
| **等待机制** | 需自行实现 | 显式等待 | waitForSelector | **自动等待 (auto-wait)** |
| **稳定性** | 依赖页面结构 | 较脆弱 | 较好 | **最佳（自动重试）** |

## 四、推荐方案：Playwright (Node.js) + RoxyBrowser API

### 选择理由

1. **RoxyBrowser 原生支持**：通过 RoxyBrowser REST API 获取 CDP WebSocket 地址，Playwright `connectOverCDP()` 直接连接
2. **登录态完美复用**：RoxyBrowser 的浏览器配置保持登录态，Playwright 连接后直接操作已登录页面
3. **Node.js 环境**：当前服务器 Python 3.6 过旧（Playwright 需 3.8+），Node.js v24 可用
4. **隐藏元素全覆盖**：`force: true` 参数可点击隐藏元素；`setInputFiles()` 可直接给隐藏 file input 设值
5. **自动等待减少脆弱性**：即梦页面有大量动态渲染，Playwright 的 auto-wait 机制自动等待元素就绪
6. **execCommand 支持**：`page.evaluate()` 执行任意 JS，处理富文本编辑器

### 已验证的连接流程

```
RoxyBrowser API (localhost:50000)
        │
        ▼
POST /browser/open ──────► 返回 WebSocket URL
        │                    ws://127.0.0.1:7243/devtools/browser/xxx
        ▼
Playwright.connectOverCDP(ws_url)
        │
        ▼
获取 browser.contexts[0].pages[0]
        │
        ▼
操作页面（导航、点击、上传、输入）
        │
        ▼
POST /browser/close ──────► 关闭浏览器
```

### RoxyBrowser API 关键接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/health` | GET | 健康检查 |
| `/browser/workspace` | GET | 获取工作区列表 |
| `/browser/list_v3` | GET | 获取浏览器配置列表（需 workspaceId） |
| `/browser/open` | POST | 打开浏览器，返回 ws/http/pid 等信息 |
| `/browser/connection_info` | GET | 获取已开启浏览器的连接信息 |
| `/browser/close` | POST | 关闭浏览器配置 |

#### /browser/open 请求参数
```json
{
    "workspaceId": 67641,
    "dirId": "8cad7738e5f3432907501466a2288d9f",
    "args": ["--remote-allow-origins=*"],
    "forceOpen": false,
    "headless": false
}
```

#### /browser/open 返回值
```json
{
    "code": 0,
    "data": {
        "dirId": "8cad7738...",
        "ws": "ws://127.0.0.1:7243/devtools/browser/f567df72-...",
        "http": "127.0.0.1:7243",
        "coreVersion": "143",
        "driver": "C:\\...\\chromedriver.exe",
        "pid": 40688,
        "windowName": "端强"
    }
}
```

### 实际测试结果

```
=== 测试 RoxyBrowser + Playwright 连接 ===
1. POST /browser/open → ws://127.0.0.1:7243/devtools/browser/f567df72-...
2. chromium.connectOverCDP(ws) → 连接成功!
3. page.goto('jimeng.jianying.com') → 页面标题: 即梦AI - 一站式AI创作平台
4. page.evaluate() → UserAgent: Chrome/143.0.0.0
5. page.screenshot() → 截图成功
=== 测试通过 ===
```

### 启动步骤

```bash
# 1. 确保 RoxyBrowser 已启动且 API 已开启（端口 50000）

# 2. 安装依赖
npm install playwright

# 3. 运行自动化脚本
node jimeng_auto.js
```

## 五、结论

**Playwright (Node.js) + RoxyBrowser API** 是最适合即梦平台自动化的方案：
- RoxyBrowser 提供指纹隔离 + 登录态持久化 + CDP WebSocket 接口
- Playwright 提供现代化的自动等待、选择器、文件上传、JS 执行能力
- 两者通过 `connectOverCDP` 无缝对接，已实际验证通过
- Node.js v24 环境可用，无 Python 版本限制
